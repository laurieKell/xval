---
title: "Bluefin" 
subtitle: "Runs"
author: "Laurence Kell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown:::pdf_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
tags: FLPKG FLR
license: Creative Commons Attribution-ShareAlike 4.0 International
---
  

```{r knitr_init, echo=FALSE, results="hide"}
library(knitr)
## Global options
opts_chunk$set(echo    =FALSE,
               eval    =TRUE,
               cache   =!FALSE,
               cache.path="../cache/om/",
               prompt  =FALSE,
               comment =NA,
               message =FALSE,
               tidy    =FALSE,
               warning =FALSE,
               fig.height=6,
               fig.width =8,
               fig.path  ="../tex/om-")

iFig=0
```
```{r, pkgs, echo=FALSE, message=FALSE}
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape2)

library(GGally)
library(corrplot)

library(ggplotFL)
library(FLRP)
library(diags)
library(r4ss)
library(ss3om)

library(gam)

options(digits=3)
```
```{r, dirs, echo=FALSE, message=FALSE}
dirMy=dirname(dirname(FLife:::getScriptPath()))
dirInp="/home/laurence/Desktop/sea++/xval/inputs/ss/run82"
dirDat=file.path(dirMy,"data")
dirBase=file.path(dirInp,"base")
```
```{r, source}
source('~/Desktop/flr/diags/R/ss-SRR.R')
```

```{r, data-ss}
ss=mlply(data.frame(scen=c("base","aspm")), 
              function(scen) SS_output(file.path(dirInp,scen),  verbose=FALSE,printstats=FALSE))
```

```{r, data-stk}
om=FLStocks(mlply(data.frame(scen=c("base","aspm")), 
                function(scen) readFLSss3(file.path(dirInp,scen))))

save(om,file=file.path(dirDat,"om.RData"),compress=TRUE)
```


\newpage
# Figures
```{r, flstock, fig.height=9}
ggplot(ldply(om,function(x) plot(x)$data))+
  geom_line(aes(year,data,col=scen))+
  facet_grid(qname~unit,scale="free")+
  xlab("Year")+ylab("")+
  guides(col=guide_legend(title="Scenario"))+
  theme_bw()
```
**Figure `r iFig=iFig+1; iFig`** Time series of recruitment, SSB, catch and fishing mortality.


```{r, srr, fig.height=6,fig.width=8}
theme_set(theme_bw())

srr=FLSRs(llply(ss,function(x) {
           res=ssSRR(x)
           #units(rec(res))=1000
           #units(ssb(res))="Tonnes"
           res}))

plot(srr)
```
**Figure `r iFig=iFig+1; iFig`** Stock recruitment relationship as fitted by SS.  


```{r ccf, fig.height=6,fig.width=8}
l_ply(srr, function(x) with(subset(model.frame(FLQuants(x,Recruits=rec,SSB=ssb)),year>1980),ccf(rank(SSB),rank(Recruits))))
```
**Figure `r iFig=iFig+1; iFig`** Cross Spearman correlations between SSB and recruitmemt, a positive lag indicates that a stock-recruit relationship and a negative lag a recruit-stock relationship.

```{r, srr2, fig.height=10}
theme_set(theme_bw())

srr=FLSRs(llply(srr,fmle,control=list(silent=TRUE)))

plot(srr)
```
**Figure `r iFig=iFig+1; iFig`** Fit to stock recruitment relationship, with goodness of fit diagnostics. 


```{r, alk}
alk=ldply(ss,function(x) subset(melt(x$ALK),value!=0))

names(alk)=c("scenario","length","age","morph","data")
alk=transform(alk,
              season=ifelse(morph%in%c("Seas: 1 Sub_Seas: 1 Morph: 1",
                                       "Seas: 1 Sub_Seas: 1 Morph: 2"),1,2),
              sex   =ifelse(morph%in%c("Seas: 1 Sub_Seas: 1 Morph: 1",
                                       "Seas: 1 Sub_Seas: 2 Morph: 1"),1,2))

dat=transform(subset(alk,season==1&scenario=="base"),sex=c("F","M")[sex])
ggplot(dat)+
   geom_histogram(aes(length,weight=data),binwidth=2)+
   facet_grid(sex~age,scale="free_x")+
   geom_vline(aes(xintercept=V1,col=sex),
               data=ddply(dat,.(age,sex), with,  
            sum(data*length)/sum(data)),size=1)+
   scale_y_continuous(breaks=NULL)+
   coord_flip()+
   xlab("Length")+ylab("Proportion")+
   theme_bw()
```
**Figure `r iFig=iFig+1; iFig`** Length distributions by age from the age length key generated by SS3.

```{r, eval=FALSE}
library(FLasher)

om1=fwd(om[[1]],catch=catch(om[[1]][,-1]))
```


```{r}
theme_set(theme_bw())

eql=as(llply(om, function(x) {
                  res=simplify(x)
                  sr =fmle(as.FLSR(res,model="bevholt"),control=list(silent=TRUE))
                  FLBRP(res,sr=sr)}),"FLBRPs")

plot(eql)
```
**Figure `r iFig=iFig+1; iFig`** Equilibrium curves with reference points.


\newpage
## Issues

+ plot(FLSRs) only plots points from 1st object
+ plot(FLSRs) How to plot residuals from all fits
+ plot(FLSRs) units(rec(res))="1000s" fails

## Software
All analysis was conducted using R and FLR and the `diags` package which provides a set of common methods for reading these data into R, plotting and summarising them.(http://www.flr-project.org/)

* `r version$version.string`
* FLCore: `r packageVersion('FLCore')`
* diags: `r # packageVersion('diags')`
* ggplotFL: `r # packageVersion('ggplotFL')`
* diags: `r # packageVersion('diags')`
* r4ss: `r # packageVersion('r4ss')`

* **Compiled**: `r date()`

## Author information

**Laurence KELL**. laurie@kell.es

# References {#References}