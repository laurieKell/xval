---
title: "Crossvalidation I"
author: "L Kell"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: word_document
---

# Estimate and compare four different forms of error i.e.

+ Model errors: from model fits
+ Prediction errors: based on leave-one-out jackknife procedure
+ Hindcast: Retrospective with projection and then compare predictions with observations
+ One-step: Retrospective with leave-one-out for final year 

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
dirMy="/home/laurence/Desktop/sea++/xval"
dirDat=file.path(dirMy,"data")
dirVpa=file.path(dirMy,"inputs/vpa")
dirTex=file.path(dirMy,"tex")
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(knitr)

opts_chunk$set(comment   =NA, 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE, 
               eval      =TRUE,
               fig.width =10, 
               fig.height=8,
               cache     =TRUE, 
               fig.path  ="../tex/xval-vpa-",
               cache.path="../cache/cache-xval-vpa/" 
               )

iFig=0
iTab=0
```

```{r init}
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(ggplotFL)
library(FLCore)
library(diags)
library(stringr)
```

```{r source}
source('~/Desktop/flr/diags/R/io.VPA2BoxV2.R')
source('~/Desktop/flr/diags/R/jackknife-vpa2box.R')
source('~/Desktop/flr/diags/R/read-VPA2Box-FLIndices.R')
```

```{r data}
m=c(0.3800,0.3000,0.2400,0.2000,0.1800,0.1600,0.1400,0.1300,0.1200,0.1000)

vpa=FLStocks("boot"=readVPA2Box(file.path(dirVpa,"ebft/bfte2017.c1"),m=m))
vpa[["fit"]]=run.vpa2box(file.path(dirVpa,"ebft/sims/bfte2017.c1"),m=m)
```

```{r vpa}
plot(vpa)
```
**Figure `r fig=1; fig`**  VPA used for 2017 assessment advice, blue best fit, pink bootstrap with CIs.


## Model residuals
```{r diags}
dgs=cbind(error="model",iter=0,diags.vpa2box(file.path(dirVpa,"ebft/sims/MINUS0.R")))
```

## Prediction residuals

```{r jack}
jk-vpa=perr.vpa2box(file.path(dirVpa,"ebft/sims/bfte2017.c1"),m=m)
save(jk-vpa,file=file.path(dirDat,"jk-vpa.RData"),compress="xz")
```
